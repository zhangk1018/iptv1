import os
import re
import requests

# ===============================
# é…ç½®åŒº
# ===============================
# å¼ºåˆ¶æŒ‡å®šç›®æ ‡è¿œç¨‹ URL
TARGET_URL = "https://raw.githubusercontent.com/linyu345/2026/refs/heads/main/py/fofa/IPTV.txt"
OUTPUT_FILE = "IPTV2.m3u"

LOGO_BASE = "https://gcore.jsdelivr.net/gh/kenye201/TVlog/img/"
EPG_URL = "https://live.fanmingming.cn/e.xml"

# é¢‘é“åˆ†ç±»å®šä¹‰
CHANNEL_CATEGORIES = {
    "å¤®è§†é¢‘é“": ["CCTV1", "CCTV2", "CCTV3", "CCTV4", "CCTV4æ¬§æ´²", "CCTV4ç¾æ´²", "CCTV5", "CCTV5+", "CCTV6", "CCTV7", "CCTV8", "CCTV9", "CCTV10", "CCTV11", "CCTV12", "CCTV13", "CCTV14", "CCTV15", "CCTV16", "CCTV17", "CCTV4K", "CCTV8K", "å…µå™¨ç§‘æŠ€", "é£äº‘éŸ³ä¹", "é£äº‘è¶³çƒ", "é£äº‘å‰§åœº", "æ€€æ—§å‰§åœº", "ç¬¬ä¸€å‰§åœº", "å¥³æ€§æ—¶å°š", "ä¸–ç•Œåœ°ç†", "å¤®è§†å°çƒ", "é«˜å°”å¤«ç½‘çƒ", "å¤®è§†æ–‡åŒ–ç²¾å“", "å«ç”Ÿå¥åº·", "ç”µè§†æŒ‡å—", "ä¸­å­¦ç”Ÿ", "å‘ç°ä¹‹æ—…", "ä¹¦æ³•é¢‘é“", "å›½å­¦é¢‘é“", "ç¯çƒå¥‡è§‚"],
    "å«è§†é¢‘é“": ["æ¹–å—å«è§†", "æµ™æ±Ÿå«è§†", "æ±Ÿè‹å«è§†", "ä¸œæ–¹å«è§†", "æ·±åœ³å«è§†", "åŒ—äº¬å«è§†", "å¹¿ä¸œå«è§†", "å¹¿è¥¿å«è§†", "ä¸œå—å«è§†", "æµ·å—å«è§†", "æ²³åŒ—å«è§†", "æ²³å—å«è§†", "æ¹–åŒ—å«è§†", "æ±Ÿè¥¿å«è§†", "å››å·å«è§†", "é‡åº†å«è§†", "è´µå·å«è§†", "äº‘å—å«è§†", "å¤©æ´¥å«è§†", "å®‰å¾½å«è§†", "å±±ä¸œå«è§†", "è¾½å®å«è§†", "é»‘é¾™æ±Ÿå«è§†", "å‰æ—å«è§†", "å†…è’™å¤å«è§†", "å®å¤å«è§†", "å±±è¥¿å«è§†", "é™•è¥¿å«è§†", "ç”˜è‚ƒå«è§†", "é’æµ·å«è§†", "æ–°ç–†å«è§†", "è¥¿è—å«è§†", "ä¸‰æ²™å«è§†", "å…µå›¢å«è§†", "å»¶è¾¹å«è§†", "å®‰å¤šå«è§†", "åº·å·´å«è§†", "å†œæ—å«è§†", "å±±ä¸œæ•™è‚²å«è§†", "ä¸­å›½æ•™è‚²1å°", "ä¸­å›½æ•™è‚²2å°", "ä¸­å›½æ•™è‚²3å°", "ä¸­å›½æ•™è‚²4å°", "æ—©æœŸæ•™è‚²"],
    "æ•°å­—é¢‘é“": ["CHCåŠ¨ä½œç”µå½±", "CHCå®¶åº­å½±é™¢", "CHCå½±è¿·ç”µå½±", "æ·˜ç”µå½±", "æ·˜ç²¾å½©", "æ·˜å‰§åœº", "æ·˜4K", "æ·˜å¨±ä¹", "æ·˜BABY", "æ·˜èŒå® ", "é‡æ¸©ç»å…¸", "æ˜Ÿç©ºå«è§†", "CHANNEL[V]", "å‡¤å‡°å«è§†ä¸­æ–‡å°", "å‡¤å‡°å«è§†èµ„è®¯å°", "å‡¤å‡°å«è§†é¦™æ¸¯å°", "å‡¤å‡°å«è§†ç”µå½±å°", "æ±‚ç´¢çºªå½•", "æ±‚ç´¢ç§‘å­¦", "æ±‚ç´¢ç”Ÿæ´»", "æ±‚ç´¢åŠ¨ç‰©", "çºªå®äººæ–‡", "é‡‘é¹°çºªå®", "çºªå®ç§‘æ•™", "ç›å½©é’å°‘", "ç›å½©ç«æŠ€", "ç›å½©ç¯®çƒ", "ç›å½©å¹¿åœºèˆ", "é­…åŠ›è¶³çƒ", "äº”æ˜Ÿä½“è‚²", "åŠ²çˆ†ä½“è‚²", "å¿«ä¹å‚é’“", "èŒ¶é¢‘é“", "å…ˆé”‹ä¹’ç¾½", "å¤©å…ƒå›´æ£‹", "æ±½æ‘©", "æ¢¨å›­é¢‘é“", "æ–‡ç‰©å®åº“", "æ­¦æœ¯ä¸–ç•Œ", "å“’å•µèµ›äº‹", "å“’å•µç”µç«", "é»‘è“ç”µå½±", "é»‘è“åŠ¨ç”»", "ä¹æ¸¸", "ç”Ÿæ´»æ—¶å°š", "éƒ½å¸‚å‰§åœº", "æ¬¢ç¬‘å‰§åœº", "æ¸¸æˆé£äº‘", "é‡‘è‰²å­¦å ‚", "åŠ¨æ¼«ç§€åœº", "æ–°åŠ¨æ¼«", "å¡é…·å°‘å„¿", "é‡‘é¹°å¡é€š", "ä¼˜æ¼«å¡é€š", "å“ˆå“ˆç‚«åŠ¨", "å˜‰ä½³å¡é€š", "ä¸­å›½äº¤é€š", "ä¸­å›½å¤©æ°”", "åæ•°4K", "åæ•°æ˜Ÿå½±", "åæ•°åŠ¨ä½œå½±é™¢", "åæ•°å–œå‰§å½±é™¢", "åæ•°å®¶åº­å½±é™¢", "åæ•°ç»å…¸ç”µå½±", "åæ•°çƒ­æ’­å‰§åœº", "åæ•°ç¢Ÿæˆ˜å‰§åœº", "åæ•°å†›æ—…å‰§åœº", "åæ•°åŸå¸‚å‰§åœº", "åæ•°æ­¦ä¾ å‰§åœº", "åæ•°å¤è£…å‰§åœº", "åæ•°é­…åŠ›æ—¶å°š", "åæ•°å°‘å„¿åŠ¨ç”»", "åæ•°åŠ¨ç”»", "iHOTçˆ±å–œå‰§", "iHOTçˆ±ç§‘å¹»", "iHOTçˆ±é™¢çº¿", "iHOTçˆ±æ‚¬ç–‘", "iHOTçˆ±å†å²", "iHOTçˆ±è°æˆ˜", "iHOTçˆ±æ—…è¡Œ", "iHOTçˆ±å¹¼æ•™", "iHOTçˆ±ç©å…·", "iHOTçˆ±ä½“è‚²", "iHOTçˆ±èµ›è½¦", "iHOTçˆ±æµªæ¼«", "iHOTçˆ±å¥‡è°ˆ", "iHOTçˆ±ç§‘å­¦", "iHOTçˆ±åŠ¨æ¼«"],
    "æ¹–åŒ—åŒºåŸŸ": ["æ¹–åŒ—å…¬å…±æ–°é—»", "æ¹–åŒ—ç»è§†é¢‘é“", "æ¹–åŒ—ç»¼åˆé¢‘é“", "æ¹–åŒ—å„ä¸Šé¢‘é“", "æ¹–åŒ—å½±è§†é¢‘é“", "æ¹–åŒ—ç”Ÿæ´»é¢‘é“", "æ¹–åŒ—æ•™è‚²é¢‘é“", "æ­¦æ±‰æ–°é—»ç»¼åˆ", "æ­¦æ±‰ç”µè§†å‰§", "æ­¦æ±‰ç§‘æŠ€ç”Ÿæ´»", "æ­¦æ±‰æ–‡ä½“é¢‘é“", "æ­¦æ±‰æ•™è‚²é¢‘é“", "é˜³æ–°ç»¼åˆ", "æˆ¿å¿ç»¼åˆ", "è”¡ç”¸ç»¼åˆ"],
    "å®‰å¾½åŒºåŸŸ": ["å®‰å¾½ç»æµç”Ÿæ´»","å®‰å¾½å…¬å…±é¢‘é“","å®‰å¾½å›½é™…é¢‘é“","å®‰å¾½å†œä¸šç§‘æ•™","å®‰å¾½å½±è§†é¢‘é“","å®‰å¾½ç»¼è‰ºä½“è‚²","å®‰åº†ç»æµç”Ÿæ´»","å®‰åº†æ–°é—»ç»¼åˆ","èšŒåŸ ç”Ÿæ´»é¢‘é“","èšŒåŸ æ–°é—»ç»¼åˆ","äº³å·å†œæ‘é¢‘é“", "äº³å·ç»¼åˆé¢‘é“","æ± å·æ–‡æ•™ç”Ÿæ´»","æ± å·æ–°é—»ç»¼åˆ","æ»å·å…¬å…±é¢‘é“","æ»å·ç§‘æ•™é¢‘é“","æ»å·æ–°é—»ç»¼åˆ","æé˜³ç”µè§†å°","ç¹æ˜Œæ–°é—»ç»¼åˆ","è‚¥è¥¿æ–°é—»ç»¼åˆ","é˜œå—æ–°é—»ç»¼åˆ","é˜œé˜³éƒ½å¸‚æ–‡è‰º", "é˜œé˜³æ•™è‚²é¢‘é“","é˜œé˜³ç”Ÿæ´»é¢‘é“","é˜œé˜³æ–°é—»ç»¼åˆ","å›ºé•‡æ–°é—»ç»¼åˆ","å¹¿å¾·ç”Ÿæ´»é¢‘é“","å¹¿å¾·æ–°é—»ç»¼åˆ","åˆè‚¥æ–°é—»é¢‘é“","æ·®åŒ—ç»æµç”Ÿæ´»","æ·®åŒ—æ–°é—»ç»¼åˆ","æ·®å—æ°‘ç”Ÿé¢‘é“","æ·®å—æ–°é—»ç»¼åˆ", "é»„å±±åŒºèåª’","é»„å±±æ–‡æ—…é¢‘é“","é»„å±±æ–°é—»ç»¼åˆ","å¾½å·æ–°é—»é¢‘é“","éœé‚±æ–°é—»ç»¼åˆ","éœå±±ç»¼åˆé¢‘é“","ç•Œé¦–ç»¼åˆé¢‘é“","é‡‘å¯¨ç»¼åˆé¢‘é“","æ—Œå¾·æ–°é—»ç»¼åˆ","éƒæºªæ–°é—»é¢‘é“","åˆ©è¾›æ–°é—»ç»¼åˆ", "ä¸´æ³‰æ–°é—»é¢‘é“","å…­å®‰ç¤¾ä¼šç”Ÿæ´»","å…­å®‰ç»¼åˆé¢‘é“","é©¬éå±±ç§‘æ•™ç”Ÿæ´»","é©¬éå±±æ–°é—»ç»¼åˆ","è’™åŸæ–°é—»é¢‘é“","å—é™µæ–°é—»ç»¼åˆ","å®å›½æ–°é—»ç»¼åˆ","ç¥é—¨ç»¼åˆé¢‘é“","æ½œå±±ç»¼åˆé¢‘é“","æ­™å¿ç»¼åˆé¢‘é“","å¯¿å¿æ–°é—»ç»¼åˆ","æ³—å¿æ–°é—»é¢‘é“","å®¿å·å…¬å…±é¢‘é“","å®¿å·ç§‘æ•™é¢‘é“","å®¿å·æ–°é—»ç»¼åˆ","æ¿‰æºªæ–°é—»é¢‘é“","å¤ªæ¹–æ–°é—»ç»¼åˆ","æ¡åŸç»¼åˆé¢‘é“","é“œé™µæ•™è‚²ç§‘æŠ€","é“œé™µæ–°é—»ç»¼åˆ", "å±¯æºªèåª’é¢‘é“","æ¹¾æ²šç»¼åˆé¢‘é“","æ¶¡é˜³æ–°é—»ç»¼åˆ","æ— ä¸ºæ–°é—»é¢‘é“","èŠœæ¹–ç”Ÿæ´»é¢‘é“","èŠœæ¹–æ–°é—»ç»¼åˆ","äº”æ²³æ–°é—»ç»¼åˆ","è§å¿æ–°é—»ç»¼åˆ","ä¼‘å®æ–°é—»ç»¼åˆ","å®£åŸæ–‡æ—…ç”Ÿæ´»","å®£åŸç»¼åˆé¢‘é“", "é»Ÿå¿æ–°é—»ç»¼åˆ","ä¹‰å®‰æ–°é—»ç»¼åˆ"],
    "å¤§æ¹¾åŒº": ["å¹¿ä¸œç æ±Ÿ","å¹¿ä¸œä½“è‚²","å¹¿ä¸œæ–°é—»","å¹¿ä¸œæ°‘ç”Ÿ","å¹¿ä¸œå½±è§†","å¹¿ä¸œç»¼è‰º","å²­å—æˆæ›²","å¹¿ä¸œç»æµç§‘æ•™", "å¹¿å·ç»¼åˆ","å¹¿å·æ–°é—»","å¹¿å·å½±è§†","å¹¿å·ç«èµ›","å¹¿å·æ³•æ²»","å¹¿å·å—å›½éƒ½å¸‚","ä½›å±±ç»¼åˆ"],
}

def get_logo_url(ch_name):
    name = ch_name.strip()
    # ç§»é™¤åç¼€
    name = re.sub(r"[ -_]HD|é«˜æ¸…|4K|è¶…æ¸…|è¶…é«˜æ¸…|8K|plus|\+|â… |â…¡|â…¢|â…£|â…¤", "", name, flags=re.IGNORECASE)
    # CCTV1 -> CCTV-1
    if name.upper().startswith("CCTV"):
        name = re.sub(r"^(CCTV)(\d+|\+)", r"\1-\2", name, flags=re.IGNORECASE).upper()
    if "æ¬§æ´²" in name or "ç¾æ´²" in name:
        name = "CCTV-4"
    return f"{LOGO_BASE}{name}.png"

def main():
    print(f"ğŸ“¡ æ­£åœ¨ä»è¿œç¨‹è·å–ç›®æ ‡æ–‡ä»¶: {TARGET_URL}")
    try:
        response = requests.get(TARGET_URL, timeout=30)
        response.raise_for_status()
        # å¼ºåˆ¶ä½¿ç”¨ utf-8 ç¼–ç ï¼Œé˜²æ­¢ä¹±ç 
        response.encoding = 'utf-8'
        content = response.text
    except Exception as e:
        print(f"âŒ è¿œç¨‹ä¸‹è½½å¤±è´¥: {e}")
        return

    lines = content.splitlines()
    m3u_lines = []
    
    for line in lines:
        line = line.strip()
        if not line or ",#genre#" in line: continue
        
        # å®‰å…¨åˆ‡åˆ†é€»è¾‘
        if "," in line:
            parts = line.split(",", 1)
            name_part = parts[0].strip()
            url_part = parts[1].strip() if len(parts) > 1 else "http://127.0.0.1"

            # 1. å¦‚æœæ˜¯æ›´æ–°æ—¶é—´è¡Œ
            if "æ›´æ–°æ—¶é—´" in name_part:
                m3u_lines.append(f'#EXTINF:-1 group-title="å…¬å‘Šè¯´æ˜",{name_part}\n{url_part}')
            
            # 2. å¦‚æœæ˜¯æ­£å¸¸çš„é¢‘é“è¡Œï¼ˆå¸¦è¿è¥å•†æ ‡å¿— $ï¼‰
            elif "$" in url_part:
                group = "å…¶ä»–é¢‘é“"
                for cat, chans in CHANNEL_CATEGORIES.items():
                    if name_part in chans:
                        group = cat
                        break
                
                logo = get_logo_url(name_part)
                m3u_lines.append(f'#EXTINF:-1 tvg-name="{name_part}" tvg-logo="{logo}" group-title="{group}",{name_part}\n{url_part}')

    # å†™å…¥è¾“å‡ºæ–‡ä»¶
    with open(OUTPUT_FILE, "w", encoding="utf-8") as out:
        out.write(f'#EXTM3U x-tvg-url="{EPG_URL}"\n\n' + "\n\n".join(m3u_lines))

    print(f"âœ… è½¬æ¢å®Œæˆï¼å·²ç”Ÿæˆæ–‡ä»¶: {OUTPUT_FILE}")
    print(f"ğŸ“Š æ€»è®¡å¤„ç†æœ‰æ•ˆé¢‘é“æ•°: {len(m3u_lines)}")

if __name__ == "__main__":
    main()
