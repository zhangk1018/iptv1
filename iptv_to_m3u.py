import os
import re
import requests

# é…ç½®
# ä¼˜å…ˆè¯»å–æœ¬åœ°æ–‡ä»¶ï¼ˆGitHub Actions è¿è¡Œæ—¶ç”Ÿæˆçš„æœ€æ–°æ–‡ä»¶ï¼‰
LOCAL_INPUT = "IPTV.txt" 
# å¤‡ç”¨è¿œç¨‹åœ°å€
REMOTE_INPUT = "https://raw.githubusercontent.com/linyu345/2026/refs/heads/main/py/fofa/IPTV.txt"
OUTPUT_FILE = "IPTV2.m3u"

LOGO_BASE = "https://gcore.jsdelivr.net/gh/kenye201/TVlog/img/"
EPG_URL = "https://live.fanmingming.cn/e.xml"

# é¢‘é“åˆ†ç±»
CHANNEL_CATEGORIES = {
    "å¤®è§†é¢‘é“": ["CCTV1", "CCTV2", "CCTV3", "CCTV4", "CCTV4æ¬§æ´²", "CCTV4ç¾æ´²", "CCTV5", "CCTV5+", "CCTV6", "CCTV7", "CCTV8", "CCTV9", "CCTV10", "CCTV11", "CCTV12", "CCTV13", "CCTV14", "CCTV15", "CCTV16", "CCTV17", "CCTV4K", "CCTV8K", "å…µå™¨ç§‘æŠ€", "é£äº‘éŸ³ä¹", "é£äº‘è¶³çƒ", "é£äº‘å‰§åœº", "æ€€æ—§å‰§åœº", "ç¬¬ä¸€å‰§åœº", "å¥³æ€§æ—¶å°š", "ä¸–ç•Œåœ°ç†", "å¤®è§†å°çƒ", "é«˜å°”å¤«ç½‘çƒ", "å¤®è§†æ–‡åŒ–ç²¾å“", "å«ç”Ÿå¥åº·", "ç”µè§†æŒ‡å—", "ä¸­å­¦ç”Ÿ", "å‘ç°ä¹‹æ—…", "ä¹¦æ³•é¢‘é“", "å›½å­¦é¢‘é“", "ç¯çƒå¥‡è§‚"],
    "å«è§†é¢‘é“": ["æ¹–å—å«è§†", "æµ™æ±Ÿå«è§†", "æ±Ÿè‹å«è§†", "ä¸œæ–¹å«è§†", "æ·±åœ³å«è§†", "åŒ—äº¬å«è§†", "å¹¿ä¸œå«è§†", "å¹¿è¥¿å«è§†", "ä¸œå—å«è§†", "æµ·å—å«è§†", "æ²³åŒ—å«è§†", "æ²³å—å«è§†", "æ¹–åŒ—å«è§†", "æ±Ÿè¥¿å«è§†", "å››å·å«è§†", "é‡åº†å«è§†", "è´µå·å«è§†", "äº‘å—å«è§†", "å¤©æ´¥å«è§†", "å®‰å¾½å«è§†", "å±±ä¸œå«è§†", "è¾½å®å«è§†", "é»‘é¾™æ±Ÿå«è§†", "å‰æ—å«è§†", "å†…è’™å¤å«è§†", "å®å¤å«è§†", "å±±è¥¿å«è§†", "é™•è¥¿å«è§†", "ç”˜è‚ƒå«è§†", "é’æµ·å«è§†", "æ–°ç–†å«è§†", "è¥¿è—å«è§†", "ä¸‰æ²™å«è§†", "å…µå›¢å«è§†", "å»¶è¾¹å«è§†", "å®‰å¤šå«è§†", "åº·å·´å«è§†", "å†œæ—å«è§†", "å±±ä¸œæ•™è‚²å«è§†", "ä¸­å›½æ•™è‚²1å°", "ä¸­å›½æ•™è‚²2å°", "ä¸­å›½æ•™è‚²3å°", "ä¸­å›½æ•™è‚²4å°", "æ—©æœŸæ•™è‚²"],
    "æ•°å­—é¢‘é“": ["CHCåŠ¨ä½œç”µå½±", "CHCå®¶åº­å½±é™¢", "CHCå½±è¿·ç”µå½±", "æ·˜ç”µå½±", "æ·˜ç²¾å½©", "æ·˜å‰§åœº", "æ·˜4K", "æ·˜å¨±ä¹", "æ·˜BABY", "æ·˜èŒå® ", "é‡æ¸©ç»å…¸", "æ˜Ÿç©ºå«è§†", "CHANNEL[V]", "å‡¤å‡°å«è§†ä¸­æ–‡å°", "å‡¤å‡°å«è§†èµ„è®¯å°", "å‡¤å‡°å«è§†é¦™æ¸¯å°", "å‡¤å‡°å«è§†ç”µå½±å°", "æ±‚ç´¢çºªå½•", "æ±‚ç´¢ç§‘å­¦", "æ±‚ç´¢ç”Ÿæ´»", "æ±‚ç´¢åŠ¨ç‰©", "çºªå®äººæ–‡", "é‡‘é¹°çºªå®", "çºªå®ç§‘æ•™", "ç›å½©é’å°‘", "ç›å½©ç«æŠ€", "ç›å½©ç¯®çƒ", "ç›å½©å¹¿åœºèˆ", "é­…åŠ›è¶³çƒ", "äº”æ˜Ÿä½“è‚²", "åŠ²çˆ†ä½“è‚²", "å¿«ä¹å‚é’“", "èŒ¶é¢‘é“", "å…ˆé”‹ä¹’ç¾½", "å¤©å…ƒå›´æ£‹", "æ±½æ‘©", "æ¢¨å›­é¢‘é“", "æ–‡ç‰©å®åº“", "æ­¦æœ¯ä¸–ç•Œ", "å“’å•µèµ›äº‹", "å“’å•µç”µç«", "é»‘è“ç”µå½±", "é»‘è“åŠ¨ç”»", "ä¹æ¸¸", "ç”Ÿæ´»æ—¶å°š", "éƒ½å¸‚å‰§åœº", "æ¬¢ç¬‘å‰§åœº", "æ¸¸æˆé£äº‘", "é‡‘è‰²å­¦å ‚", "åŠ¨æ¼«ç§€åœº", "æ–°åŠ¨æ¼«", "å¡é…·å°‘å„¿", "é‡‘é¹°å¡é€š", "ä¼˜æ¼«å¡é€š", "å“ˆå“ˆç‚«åŠ¨", "å˜‰ä½³å¡é€š", "ä¸­å›½äº¤é€š", "ä¸­å›½å¤©æ°”", "åæ•°4K", "åæ•°æ˜Ÿå½±", "åæ•°åŠ¨ä½œå½±é™¢", "åæ•°å–œå‰§å½±é™¢", "åæ•°å®¶åº­å½±é™¢", "åæ•°ç»å…¸ç”µå½±", "åæ•°çƒ­æ’­å‰§åœº", "åæ•°ç¢Ÿæˆ˜å‰§åœº", "åæ•°å†›æ—…å‰§åœº", "åæ•°åŸå¸‚å‰§åœº", "åæ•°æ­¦ä¾ å‰§åœº", "åæ•°å¤è£…å‰§åœº", "åæ•°é­…åŠ›æ—¶å°š", "åæ•°å°‘å„¿åŠ¨ç”»", "åæ•°åŠ¨ç”»", "iHOTçˆ±å–œå‰§", "iHOTçˆ±ç§‘å¹»", "iHOTçˆ±é™¢çº¿", "iHOTçˆ±æ‚¬ç–‘", "iHOTçˆ±å†å²", "iHOTçˆ±è°æˆ˜", "iHOTçˆ±æ—…è¡Œ", "iHOTçˆ±å¹¼æ•™", "iHOTçˆ±ç©å…·", "iHOTçˆ±ä½“è‚²", "iHOTçˆ±èµ›è½¦", "iHOTçˆ±æµªæ¼«", "iHOTçˆ±å¥‡è°ˆ", "iHOTçˆ±ç§‘å­¦", "iHOTçˆ±åŠ¨æ¼«"],
    "æ¹–åŒ—åŒºåŸŸ": ["æ¹–åŒ—å…¬å…±æ–°é—»", "æ¹–åŒ—ç»è§†é¢‘é“", "æ¹–åŒ—ç»¼åˆé¢‘é“", "æ¹–åŒ—å„ä¸Šé¢‘é“", "æ¹–åŒ—å½±è§†é¢‘é“", "æ¹–åŒ—ç”Ÿæ´»é¢‘é“", "æ¹–åŒ—æ•™è‚²é¢‘é“", "æ­¦æ±‰æ–°é—»ç»¼åˆ", "æ­¦æ±‰ç”µè§†å‰§", "æ­¦æ±‰ç§‘æŠ€ç”Ÿæ´»", "æ­¦æ±‰æ–‡ä½“é¢‘é“", "æ­¦æ±‰æ•™è‚²é¢‘é“", "é˜³æ–°ç»¼åˆ", "æˆ¿å¿ç»¼åˆ", "è”¡ç”¸ç»¼åˆ"],
    "å®‰å¾½åŒºåŸŸ": ["å®‰å¾½ç»æµç”Ÿæ´»","å®‰å¾½å…¬å…±é¢‘é“","å®‰å¾½å›½é™…é¢‘é“","å®‰å¾½å†œä¸šç§‘æ•™","å®‰å¾½å½±è§†é¢‘é“","å®‰å¾½ç»¼è‰ºä½“è‚²","å®‰åº†ç»æµç”Ÿæ´»","å®‰åº†æ–°é—»ç»¼åˆ","èšŒåŸ ç”Ÿæ´»é¢‘é“","èšŒåŸ æ–°é—»ç»¼åˆ","äº³å·å†œæ‘é¢‘é“", "äº³å·ç»¼åˆé¢‘é“","æ± å·æ–‡æ•™ç”Ÿæ´»","æ± å·æ–°é—»ç»¼åˆ","æ»å·å…¬å…±é¢‘é“","æ»å·ç§‘æ•™é¢‘é“","æ»å·æ–°é—»ç»¼åˆ","æé˜³ç”µè§†å°","ç¹æ˜Œæ–°é—»ç»¼åˆ","è‚¥è¥¿æ–°é—»ç»¼åˆ","é˜œå—æ–°é—»ç»¼åˆ","é˜œé˜³éƒ½å¸‚æ–‡è‰º", "é˜œé˜³æ•™è‚²é¢‘é“","é˜œé˜³ç”Ÿæ´»é¢‘é“","é˜œé˜³æ–°é—»ç»¼åˆ","å›ºé•‡æ–°é—»ç»¼åˆ","å¹¿å¾·ç”Ÿæ´»é¢‘é“","å¹¿å¾·æ–°é—»ç»¼åˆ","åˆè‚¥æ–°é—»é¢‘é“","æ·®åŒ—ç»æµç”Ÿæ´»","æ·®åŒ—æ–°é—»ç»¼åˆ","æ·®å—æ°‘ç”Ÿé¢‘é“","æ·®å—æ–°é—»ç»¼åˆ", "é»„å±±åŒºèåª’","é»„å±±æ–‡æ—…é¢‘é“","é»„å±±æ–°é—»ç»¼åˆ","å¾½å·æ–°é—»é¢‘é“","éœé‚±æ–°é—»ç»¼åˆ","éœå±±ç»¼åˆé¢‘é“","ç•Œé¦–ç»¼åˆé¢‘é“","é‡‘å¯¨ç»¼åˆé¢‘é“","æ—Œå¾·æ–°é—»ç»¼åˆ","éƒæºªæ–°é—»é¢‘é“","åˆ©è¾›æ–°é—»ç»¼åˆ", "ä¸´æ³‰æ–°é—»é¢‘é“","å…­å®‰ç¤¾ä¼šç”Ÿæ´»","å…­å®‰ç»¼åˆé¢‘é“","é©¬éå±±ç§‘æ•™ç”Ÿæ´»","é©¬éå±±æ–°é—»ç»¼åˆ","è’™åŸæ–°é—»é¢‘é“","å—é™µæ–°é—»ç»¼åˆ","å®å›½æ–°é—»ç»¼åˆ","ç¥é—¨ç»¼åˆé¢‘é“","æ½œå±±ç»¼åˆé¢‘é“","æ­™å¿ç»¼åˆé¢‘é“","å¯¿å¿æ–°é—»ç»¼åˆ","æ³—å¿æ–°é—»é¢‘é“","å®¿å·å…¬å…±é¢‘é“","å®¿å·ç§‘æ•™é¢‘é“","å®¿å·æ–°é—»ç»¼åˆ","æ¿‰æºªæ–°é—»é¢‘é“","å¤ªæ¹–æ–°é—»ç»¼åˆ","æ¡åŸç»¼åˆé¢‘é“","é“œé™µæ•™è‚²ç§‘æŠ€","é“œé™µæ–°é—»ç»¼åˆ", "å±¯æºªèåª’é¢‘é“","æ¹¾æ²šç»¼åˆé¢‘é“","æ¶¡é˜³æ–°é—»ç»¼åˆ","æ— ä¸ºæ–°é—»é¢‘é“","èŠœæ¹–ç”Ÿæ´»é¢‘é“","èŠœæ¹–æ–°é—»ç»¼åˆ","äº”æ²³æ–°é—»ç»¼åˆ","è§å¿æ–°é—»ç»¼åˆ","ä¼‘å®æ–°é—»ç»¼åˆ","å®£åŸæ–‡æ—…ç”Ÿæ´»","å®£åŸç»¼åˆé¢‘é“", "é»Ÿå¿æ–°é—»ç»¼åˆ","ä¹‰å®‰æ–°é—»ç»¼åˆ"],
    "å¤§æ¹¾åŒº": ["å¹¿ä¸œç æ±Ÿ","å¹¿ä¸œä½“è‚²","å¹¿ä¸œæ–°é—»","å¹¿ä¸œæ°‘ç”Ÿ","å¹¿ä¸œå½±è§†","å¹¿ä¸œç»¼è‰º","å²­å—æˆæ›²","å¹¿ä¸œç»æµç§‘æ•™", "å¹¿å·ç»¼åˆ","å¹¿å·æ–°é—»","å¹¿å·å½±è§†","å¹¿å·ç«èµ›","å¹¿å·æ³•æ²»","å¹¿å·å—å›½éƒ½å¸‚","ä½›å±±ç»¼åˆ"],
}

def get_logo_url(ch_name):
    """
    è‡ªåŠ¨å¤„ç†å°æ ‡é€»è¾‘ï¼š
    1. ç§»é™¤é«˜æ¸…/4Kç­‰åç¼€
    2. CCTVç³»åˆ—è‡ªåŠ¨è¡¥å…¨æ¨ªæ  (CCTV1 -> CCTV-1)
    """
    name = ch_name.strip()
    # ç§»é™¤å¹²æ‰°è¯
    name = re.sub(r"[ -_]HD|é«˜æ¸…|4K|è¶…æ¸…|è¶…é«˜æ¸…|8K|plus|\+|â… |â…¡|â…¢|â…£|â…¤", "", name, flags=re.IGNORECASE)
    
    # æ ¸å¿ƒè½¬æ¢ï¼šCCTV1 -> CCTV-1
    if name.upper().startswith("CCTV"):
        name = re.sub(r"^(CCTV)(\d+|\+)", r"\1-\2", name, flags=re.IGNORECASE).upper()
    
    # ç‰¹æ®Šåˆ†æ”¯å¤„ç†
    if "æ¬§æ´²" in name or "ç¾æ´²" in name:
        name = "CCTV-4"
        
    return f"{LOGO_BASE}{name}.png"

def main():
    content = ""
    # ç­–ç•¥ï¼šå¦‚æœæœ¬åœ°æœ‰æ–‡ä»¶ï¼ˆActionsç¯å¢ƒï¼‰ï¼Œç›´æ¥è¯»æœ¬åœ°ï¼›å¦åˆ™å»ä¸‹è½½
    if os.path.exists(LOCAL_INPUT):
        print(f"ğŸ“‚ å‘ç°æœ¬åœ°æ–‡ä»¶ {LOCAL_INPUT}ï¼Œæ­£åœ¨è¯»å–...")
        with open(LOCAL_INPUT, "r", encoding="utf-8") as f:
            content = f.read()
    else:
        print(f"ğŸŒ æœ¬åœ°æ— æ–‡ä»¶ï¼Œå°è¯•ä»è¿œç¨‹ä¸‹è½½: {REMOTE_INPUT}")
        try:
            r = requests.get(REMOTE_INPUT, timeout=30)
            r.raise_for_status()
            content = r.text
        except Exception as e:
            print(f"âŒ è¯»å–å¤±è´¥: {e}")
            return

    lines = content.splitlines()
    m3u_lines = []
    
    for line in lines:
        line = line.strip()
        if not line or ",#genre#" in line: continue
        
        # å¤„ç†æ›´æ–°æ—¶é—´
        if "æ›´æ–°æ—¶é—´" in line:
            parts = line.split(",", 1)
            m3u_lines.append(f'#EXTINF:-1 group-title="å…¬å‘Šè¯´æ˜",{parts[0]}\n{parts[1]}')
            continue

        # å¤„ç†é¢‘é“
        if "," in line and "$" in line:
            ch_name, url_with_op = line.split(",", 1)
            ch_name = ch_name.strip()
            
            # è‡ªåŠ¨åˆ†ç±»
            group = "å…¶ä»–é¢‘é“"
            for cat, chans in CHANNEL_CATEGORIES.items():
                if ch_name in chans:
                    group = cat
                    break
            
            logo = get_logo_url(ch_name)
            m3u_lines.append(f'#EXTINF:-1 tvg-name="{ch_name}" tvg-logo="{logo}" group-title="{group}",{ch_name}\n{url_with_op.strip()}')

    # å†™å…¥æ–‡ä»¶
    with open(OUTPUT_FILE, "w", encoding="utf-8") as out:
        out.write(f'#EXTM3U x-tvg-url="{EPG_URL}"\n\n' + "\n\n".join(m3u_lines))

    print(f"âœ… è½¬æ¢å®Œæˆï¼ç”Ÿæˆæ–‡ä»¶: {OUTPUT_FILE}")

if __name__ == "__main__":
    main()
